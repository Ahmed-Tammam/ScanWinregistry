import winreg
import re
import os

# List of well-known registry keys associated with malware or attacks
MALWARE_KEYS = [
    r"Software\Microsoft\Windows\CurrentVersion\Run",
    r"Software\Microsoft\Windows\CurrentVersion\RunOnce",
    r"Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run",
    r"Software\Microsoft\Windows\CurrentVersion\RunServices",
    r"Software\Microsoft\Windows\CurrentVersion\RunServicesOnce",
    r"Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit",
    r"Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell",
    r"Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Taskman",
    r"Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify",
    r"Software\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions",
    r"Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options",
    r"Software\Microsoft\Windows NT\CurrentVersion\Drivers32",
    r"Software\Microsoft\Internet Explorer\Extensions\CommandFlags",
    r"Software\Microsoft\Internet Explorer\Extensions\Exec",
    r"Software\Microsoft\Internet Explorer\Extensions\CLSID",
    r"Software\Microsoft\Internet Explorer\Extensions\MenuText",
    r"Software\Microsoft\Internet Explorer\Toolbar\WebBrowser",
    r"Software\Microsoft\Office\Outlook\Addins",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.VbaAddinForOutlook",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.OutlookBackup.1",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.OutlookBackup",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.OutlookBackup.2",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.OutlookBackup.3",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.DigitalDashboard.OutlookAddIn",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.DigitalDashboard.OutlookAddIn.1",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.VbaAddinForOutlook.1",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.VbaAddinForOutlook.2",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.VbaAddinForOutlook.3",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.OutlookBackup.4",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.OutlookBackup.5",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.OutlookBackup.6",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.OutlookBackup.7",
    r"Software\Microsoft\Office\Outlook\Addins\Microsoft.OutlookBackup.8",
]

# Regular expressions to match obfuscated or random registry key names
MALWARE_REGEXES = [
    r"^[a-z]{8}$",  # Matches registry keys with 8 lowercase letters
    r"^[0-9]{8}$",  # Matches registry keys with 8 digits
    r"^[a-f0-9]{32}$",  # Matches registry keys with 32 hexadecimal digits
]

MALWARE_SIGNATURES = [
    b"\x4D\x5A",  # MZ header 
    b"\x5A\x4D",  # ZM header 
    b"\x7F\x45\x4C\x46",  # ELF header )
    b"\x50\x45\x00\x00", # PE header
    b"\x55\x50\x58\x21\x1C\xF7\x02\x00\x00\x00", # UPX header
    b"\x4E\x53\x49\x53\x00\x00\x00\x00\x04\x00\x00\x00", # NSIS installer header
    b"\xD0\xCF\x11\xE0\xA1\xB1\x1A\xE1\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x00\x03\x00\xFF\xFF\x09\x00\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00", # VBA macro signature
    b"\x46\x57\x53", # SWF file signature 
]

SUSPICIOUS_FILE_PATH_PATTERN = re.compile(r"[a-z]:\\\\windows\\\\system(32|64)\\\\", re.IGNORECASE)

key = winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, "", 0, winreg.KEY_READ)

malware_keys_found = []
for malware_key in MALWARE_KEYS:
    try:
        sub_key = winreg.OpenKey(key, malware_key, 0, winreg.KEY_READ)
        malware_keys_found.append(malware_key)
        sub_key.Close()
    except FileNotFoundError:
        pass

# Check the values of the well-known registry keys
malware_values_found = []
for malware_key in malware_keys_found:
    sub_key = winreg.OpenKey(key, malware_key, 0, winreg.KEY_READ)
    num_values = winreg.QueryInfoKey(sub_key)[1]
    for i in range(num_values):
        value_name, value_data, value_type = winreg.EnumValue(sub_key, i)
        if isinstance(value_data, str) and any(ext in value_data.lower() for ext in [".exe", ".bat", ".cmd"]):
            print(f"Registry key {malware_key} contains a suspicious value: {value_name}={value_data}")
        if isinstance(value_data, str) and SUSPICIOUS_FILE_PATH_PATTERN.search(value_data):
            print(f"Registry key '{malware_key}' contains a suspicious value: {value_name}={value_data}")
        if isinstance(value_data, bytes) and any(signature in value_data for signature in MALWARE_SIGNATURES):
            print(f"Registry key {malware_key} contains a file with a known malware signature: {value_name}")
        if isinstance(value_data, str) and os.path.exists(value_data) and os.path.isfile(value_data) and any(signature in open(value_data, "rb").read() for signature in MALWARE_SIGNATURES):
            print(f"File {value_data} has a known malware signature and is referenced in registry key {malware_key}")
    sub_key.Close()
key.Close()
